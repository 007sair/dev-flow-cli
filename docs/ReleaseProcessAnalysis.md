# 发布流程深度解析与常见问题解答

本文档基于 `dev-flow-cli` 的代码实现与设计理念，深入剖析了“预发布”与“正式发布”的双阶段流程，并针对 Git 历史整洁性问题进行了解答。

## 1. 发布流程详解

`dev-flow-cli` 将发布流程拆分为两个独立的阶段，以确保代码的稳定性和版本管理的规范性。

### 1.1 预发布阶段 (Pre-Release)

**核心目标**：代码冻结 (Code Freeze) 与测试准备。

**操作流程**：
1.  **来源选择**：从活跃的公共特性分支（如 `feat/1.2.0`）中拉取最新代码。
2.  **版本确定**：根据语义化版本规范 (SemVer) 确定下一个版本号（如 `v1.2.1`），但此时**不修改** `package.json`。
3.  **分支隔离**：创建并推送 `release/v1.2.1` 分支。

**代码逻辑**：
该阶段仅仅是创建了一个“快照”分支。
- **为什么要做这一步？** 
  - **隔离干扰**：`feat` 分支可能随时有新功能合入。通过创建 `release` 分支，我们建立了一个只允许修复 Bug、不允许加新功能的“隔离区”。
  - **CI/CD 触发**：DevOps 系统通常监听 `release/*` 分支，自动部署到 Staging 环境供 QA 测试。

### 1.2 正式发布阶段 (Release Finish)

**核心目标**：版本封版 (Sign-off) 与产物生成。

**操作流程**：
1.  **分支锁定**：选择一个已通过测试的 `release` 分支。
2.  **自动化产出**：调用 `standard-version` 工具：
    - 修改 `package.json` 版本号。
    - 扫描 Commit History 自动生成 `CHANGELOG.md`。
    - 创建 Git Tag（如 `v1.2.1`）。
3.  **最终推送**：将包含 Tag 和 Changelog 的代码推送到远程。

---

## 2. 核心问题解答 (QA)

### Q1: 为什么要将上线流程拆分成 2 个阶段？

**A: 为了平衡“敏捷开发”与“稳定发布”的矛盾。**

如果不拆分，直接从 `feat` 分支发版，会遇到以下致命问题：
1.  **版本号抢占**：在测试期间，如果有紧急 Bug 修复或新功能插入，版本号管理会变得混乱。预发布阶段提前锁定了版本目标。
2.  **测试环境不稳**：如果测试环境直接使用 `feat` 分支，开发人员的新提交会不断重置测试环境，导致测试中断。`release` 分支提供了一个稳定的缓冲地带。

### Q2: 整个流程似乎没有看到 Squash？它有必要吗？

**A: 非常有必要，它被前置到了“特性同步”阶段。**

你没有在发布阶段看到 Squash，是因为 `dev-flow-cli` 坚持 **“原子化提交 (Atomic Commits)”** 原则：
- **发布阶段不应处理代码质量问题**：发布时，代码历史应该已经是完美的。
- **特性同步 (Feature Sync) 才是清理场**：当个人分支合并入公共分支时，工具会自动执行 `git reset --soft`，将你个人的 10 个杂乱提交（wip, fix typo 等）压缩成 **1 个** 包含完整上下文的原子提交。
- **结果**：`standard-version` 生成 Changelog 时，读取到的都是经过精心修饰的 Commit Message，保证了文档的高质量。

---

## 3. 进阶场景探讨：公共分支的“脏历史”处理

**问题描述**：
如果 `feat` 分支上已经存在了多人协作导致的多次杂乱提交（例如某人没有使用 CLI 工具，直接 merge 了代码），或者更新频率过快导致历史不线性，该怎么办？

**解决方案**：

虽然 `dev-flow-cli` 主要约束**个人 -> 公共**的合并过程，但对于公共分支本身的治理，建议遵循以下策略：

### 3.1 预防胜于治疗：强制使用 CLI
团队应达成共识，**禁止**直接使用 `git merge` 合并个人分支到公共分支。必须使用 `flow` 的“特性同步”功能，利用其内置的 `Rebase` + `Squash` 机制来保证合入的永远是单节点。

### 3.2 补救措施：交互式变基 (Interactive Rebase)
如果 `feat` 分支已经脏了（包含大量无意义提交），Team Leader 可以在发布前进行一次清洗：

```bash
# 在 feat 分支上
git rebase -i HEAD~20
```
手动将 `pick` 改为 `squash`，合并琐碎提交。

### 3.3 CLI 工具的增强思路 (Feature Request)
针对“特性分支更新过于频繁”导致个人分支 Rebase 困难的问题，`dev-flow-cli` 的 `feature-sync-pro` 已经内置了解决方案：
1.  **自动 Rebase**：在合并前，工具会自动拉取远程 `feat` 代码并执行 `git rebase origin/feat`。
2.  **冲突处理引导**：如果因更新频繁导致冲突，工具会暂停并引导用户解决冲突，解决后继续流程。

**极端情况处理**：
如果公共分支更新太快，导致每次 Rebase 都极其痛苦，这通常是**分支策略划分过粗**的信号。建议：
- 拆分 `feat` 分支：不要让所有人都往同一个 `feat/1.2.0` 合并。
- 按模块拆分：`feat/user-module`, `feat/order-module`。
- 各个模块负责人维护自己的线性历史，最后再通过 Merge Request (GitLab/GitHub) 合并到总的 Release 分支，此时可以使用 `Squash and Merge` 策略作为最后一道防线。
